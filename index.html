<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>GLM-4.5 Chatbot (Smart Output)</title>
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet"/>
  <style>
    body {background:#f5f7fb;font-family:sans-serif;}
    .glm-chatbox { max-width:460px;margin:40px auto;border:1px solid #bbb;border-radius:8px;padding:12px;background:#fafaff; }
    .glm-messages { max-height:400px;overflow-y:auto;margin-bottom:10px;display:flex;flex-direction:column;gap:6px;}
    .glm-msg {padding:8px 12px;border-radius:6px;max-width:90%;word-break:break-word;white-space:pre-wrap;}
    .glm-msg.user {background:#d1e7ff;align-self:flex-end;}
    .glm-msg.bot {background:#e9ecef;align-self:flex-start;}
    .glm-inputrow {display:flex;gap:8px;}
    .glm-inpt {flex:1;padding:8px;border:1px solid #bbb;border-radius:5px;}
    .glm-btn {padding:8px 18px;background:#2a72ff;color:white;border:none;border-radius:4px;cursor:pointer;}
    .glm-btn:active {background:#1649a3;}
    .glm-controls {display:flex;gap:8px;margin-bottom:8px;}
    .glm-select {padding:6px 12px;border-radius:4px;border:1px solid #bbb;}
    pre {margin:8px 0;}
  </style>
</head>
<body>
  <div class="glm-chatbox">
    <div class="glm-controls">
      <label>
        Output Style
        <select id="output-mode" class="glm-select">
          <option value="chat">สนทนาปกติ (Chat)</option>
          <option value="code">โค้ดเท่านั้น (Code Only)</option>
          <option value="explain+code">อธิบาย+โค้ด (Explain + Code)</option>
          <option value="json">JSON Only</option>
        </select>
      </label>
    </div>
    <div class="glm-messages" id="glm-messages"></div>
    <form class="glm-inputrow" id="glm-form" autocomplete="off">
      <input class="glm-inpt" id="glm-input" placeholder="พิมพ์ข้อความ..."/>
      <button class="glm-btn" id="glm-send" type="submit">ส่ง</button>
    </form>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
  <script>
    // --- CONFIG ---
    const API_KEY = "129f947ce9fd44c28a3358a73dbb0173.1TQiPjq06MUytu5P";
    const ENDPOINT = "https://open.bigmodel.cn/api/paas/v4/chat/completions";
    // --- STATE ---
    let outputMode = "chat";
    let systemPrompt = getSystemPrompt(outputMode);
    let conversation = [
      {
        role: "system",
        content: `You are a senior engineer who specializes in coding and web design. 
You always provide clear, efficient, and well-structured code with best practices. 
Your answers should be concise, professional, and if user speaks Thai, you reply in Thai; otherwise, use English.
Give practical code-focused solutions and advice.`
      }
    ];
    // --- ELEMENTS ---
    const messagesDiv = document.getElementById('glm-messages');
    const input = document.getElementById('glm-input');
    const form = document.getElementById('glm-form');
    const outputSelect = document.getElementById('output-mode');
    // --- FUNCTIONS ---
    function getSystemPrompt(mode) {
      switch (mode) {
        case "chat":
          return `You are a senior engineer who specializes in coding and web design. 
Always provide clear, efficient, and well-structured code with best practices when relevant.  
If the user speaks Thai, answer in Thai; otherwise, use English.
Respond in a conversational style.`;
        case "code":
          return `You are a senior engineer. 
Return only the code in language-specific code blocks (e.g., \`\`\`python ...\`\`\`). 
Do not add explanation or comments unless requested.`;
        case "explain+code":
          return `You are a senior engineer.
Briefly explain your approach first in 1-2 sentences, then provide the code in the proper code block (e.g., \`\`\`python ...\`\`\`). 
If the user speaks Thai, explain in Thai; otherwise, use English.`;
        case "json":
          return `You are a senior engineer. 
Return only a JSON object in a \`\`\`json ...\`\`\` code block, no extra explanation.`;
        default:
          return `You are a senior engineer who specializes in coding and web design. 
If the user speaks Thai, answer in Thai; otherwise, use English.`;
      }
    }
    function setOutputMode(mode) {
      outputMode = mode;
      systemPrompt = getSystemPrompt(mode);
      // update system prompt ใน conversation (ลบอันเก่า ใส่อันใหม่)
      conversation = conversation.filter(msg => msg.role !== "system");
      conversation.unshift({role: "system", content: systemPrompt});
    }
    outputSelect.onchange = e => setOutputMode(e.target.value);

    // -- Render messages with code highlight --
    function renderChat() {
      messagesDiv.innerHTML = '';
      conversation.filter(msg => msg.role !== "system").forEach(msg => {
        const div = document.createElement('div');
        div.className = "glm-msg " + (msg.role === "user" ? "user" : "bot");
        div.innerHTML = (msg.role === "assistant")
          ? renderAssistant(msg.content)
          : escapeHTML(msg.content);
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      Prism.highlightAll();
    }
    // Render assistant output, highlight code blocks
    function renderAssistant(text) {
      // แยก code block (```lang ... ```)
      return text.replace(/```(\w+)?\n([\s\S]*?)```/g, (m, lang, code) => {
        lang = lang || "plaintext";
        return `<pre><code class="language-${lang}">${Prism.highlight(escapeHTML(code), Prism.languages[lang] || Prism.languages.plaintext, lang)}</code></pre>`;
      }).replace(/\n/g, "<br>");
    }
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, ch => (
        { "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[ch]
      ));
    }

    // --- Send to GLM4.5 (with stream) ---
    async function sendToGLM(msg) {
      conversation.push({role: "user", content: msg});
      renderChat();
      input.value = "";
      input.disabled = true;
      // Add placeholder for streaming reply
      conversation.push({role: "assistant", content: ""});
      renderChat();
      const index = conversation.length - 1;
      try {
        const response = await fetch(ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + API_KEY
          },
          body: JSON.stringify({
            model: "glm-4.5",
            messages: conversation.slice(-20),
            temperature: 0.8,
            stream: true
          })
        });
        if (!response.body) throw new Error("No stream body");
        const reader = response.body.getReader();
        let decoder = new TextDecoder();
        let done = false, buffer = '';
        while (!done) {
          const {value, done: doneReading} = await reader.read();
          done = doneReading;
          if (value) {
            buffer += decoder.decode(value, {stream:true});
            let parts = buffer.split("\n");
            buffer = parts.pop(); // keep last part in buffer (may be incomplete)
            for (let line of parts) {
              line = line.trim();
              if (!line.startsWith("data:") || line === "data: [DONE]") continue;
              try {
                const j = JSON.parse(line.replace(/^data:\s*/,""));
                const delta = j.choices?.[0]?.delta?.content || "";
                if (delta) {
                  conversation[index].content += delta;
                  renderChat();
                }
              } catch {}
            }
          }
        }
      } catch (e) {
        conversation[index].content = "เกิดข้อผิดพลาด: " + e.message;
        renderChat();
      }
      input.disabled = false;
      input.focus();
    }
    // --- Form submit handler ---
    form.onsubmit = e => {
      e.preventDefault();
      const msg = input.value.trim();
      if (!msg) return;
      sendToGLM(msg);
    };
    // --- Initial render ---
    renderChat();
  </script>
</body>
</html>
