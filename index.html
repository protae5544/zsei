<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Z AI GLM-4.5 Proxy Playground</title>
  <style>
    :root {
      --gold: #d4af37;
      --crane-red: #b91c1c;
      --bg: #f7f5f0;
      --text: #111;
      --muted: #555;
      --card: #fff;
      --border: #e5e5e5;
      --shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", sans-serif;
          background: linear-gradient(135deg, #fff 0, #f7f1e3 60%, #fff 100%);
          margin:0; color:var(--text);}
    .container{ max-width: 980px; margin:0 auto; padding:16px; display:grid; grid-template-columns:1fr 1fr; gap:16px;}
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:var(--shadow);}
    h2{ font-size:1.05rem; margin:6px 0 12px;}
    label{ font-size:12px; color:var(--muted); display:block; margin-top:8px; }
    input, textarea, select{ width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; font:inherit; }
    textarea{ min-height:90px; resize: vertical; }
    .row{ display:flex; gap:8px; align-items:center; }
    .btn{ background: rgba(255,255,255,.9); border:1px solid #ccc; padding:10px 14px; border-radius:8px; font-weight:700; cursor:pointer; }
    .btn.primary{ background: linear-gradient(135deg, var(--gold), #ffd000); border:none; }
    .ghost{ background: rgba(255,255,255,.6); border:1px solid rgba(0,0,0,.2);}
    .crane{ position:absolute; top: -20px; right:-40px; width:200px; opacity:.25; filter: drop-shadow(0 6px 18px rgba(0,0,0,.25)); pointer-events:none; }
    .messages{ height:40vh; overflow:auto; border-radius:8px; padding:6px; border:1px solid var(--border); background:#fff; }
    .message{ display:flex; margin:6px 0; }
    .user{ justify-content:flex-end; }
    .bubble{ max-width:70%; padding:12px 14px; border-radius:14px; background:#f2f2f2; }
    .user .bubble{ background: linear-gradient(135deg, #111, #333); color:#fff; }
    #debugPanel{ display:none; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; padding:10px; border-radius:8px; border:1px solid var(--border); background:#fff8dc; max-height:180px; overflow:auto; }
    @media (max-width: 900px){
      .container{ grid-template-columns:1fr; }
      .crane{ display:none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Decorative vector crane -->
    <div class="card" style="position:relative;">
      <svg class="crane" viewBox="0 0 260 260" width="200" height="200" aria-label=" crane-vector">
        <defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop offset="0%" stop-color="#ffd56b"/><stop offset="100%" stop-color="#d4a017"/></linearGradient></defs>
        <line x1="130" y1="0" x2="130" y2="40" stroke="url(#g)" stroke-width="2"/>
        <line x1="130" y1="40" x2="60" y2="190" stroke="url(#g)" stroke-width="2"/>
        <line x1="60" y1="190" x2="120" y2="170" stroke="url(#g)" stroke-width="2"/>
        <circle cx="160" cy="120" r="6" fill="url(#g)"/>
        <path d="M170 120 L184 116" stroke="url(#g)" stroke-width="2" />
        <path d="M60 190 C70 150, 120 120, 150 130" fill="none" stroke="url(#g)" stroke-width="2"/>
      </svg>
      <h2>Z AI GLM-4.5 Proxy on Netlify</h2>
      <p>UI สำหรับส่ง prompt และดูผลแบบเรียลไทม์ผ่าน GLM-4.5 โดยไม่เปิดเผย API keys ใน frontend</p>
    </div>

    <!-- Input config for Netlify/GLM -->
    <div class="card" aria-label="Configuration">
      <h2>Configuration</h2>
      <div class="row">
        <label>Prompt</label>
      </div>
      <textarea id="prompt" placeholder="พิมพ์ข้อความที่ต้องการถาม..." ></textarea>

      <div class="row" style="margin-top:8px;">
        <div style="flex:1;">
          <label>Model</label>
          <select id="model">
            <option value="glm-4.5" selected>glm-4.5</option>
            <option value="glm-4v-plus">glm-4v-plus</option>
          </select>
        </div>
        <div style="flex:1;">
          <label>Temperature</label>
          <input id="temp" type="number" min="0" max="1" step="0.1" value="0.7" />
        </div>
        <div style="flex:1;">
          <label>Max Tokens</label>
          <input id="maxTokens" type="number" value="2000" />
        </div>
      </div>

      <div class="row" style="margin-top:8px; align-items:center;">
        <label style="display:flex; align-items:center; gap:8px;">
          <input id="stream" type="checkbox" checked />
          Streaming (client-side simulate)
        </label>
      </div>

      <button class="btn primary" style="margin-top:8px;" onclick="sendPrompt()">ส่ง</button>
    </div>

    <!-- Preview/Output -->
    <div class="card" aria-label="Conversation">
      <h2>Conversation</h2>
      <div class="messages" id="messages"></div>
    </div>

    <div class="card" aria-label="Environment & Deployment">
      <h2>Netlify Deployment Helpers</h2>
      <p>Environment variables (ตั้งค่าใน Netlify UI):</p>
      <ul>
        <li>GLM_BASE_URL: URL ของ GLM-4.5 API</li>
        <li>GLM_API_KEY: คีย์ API (เก็บเป็น Secret ใน Netlify)</li>
        <li>GLM_MODEL: glm-4.5</li>
        <li>GLM_TEMPERATURE: 0.7</li>
        <li>GLM_MAX_TOKENS: 2000</li>
        <li>GLM_ENDPOINT: จุดที่เรียก เช่น /glm/v1/chat/completions (ขึ้นกับ docs)</li>
      </ul>
      <p>ไฟล์ใน repo ที่เกี่ยวข้อง: netlify.toml, netlify/functions/glm-proxy.js</p>
      <button class="btn ghost" onclick="fillSampleEnv()">แสดงค่าตัวอย่าง env</button>
      <pre id="envSample" style="display:none; background:#f7f7f7; padding:8px; border-radius:6px;"></pre>
    </div>

    <div id="debugPanel" class="card" style="display:none;">
      <h2>Debug</h2>
      <div id="debugInfo" style="white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;"></div>
    </div>
  </div>

  <script>
    const msgs = document.getElementById('messages');
    function addMessage(text, fromUser){
      const row = document.createElement('div');
      row.className = 'message ' + (fromUser ? 'user' : 'bot');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      row.appendChild(bubble);
      msgs.appendChild(row);
      msgs.scrollTop = msgs.scrollHeight;
    }

    function fillSampleEnv(){
      const sample = [
        "GLM_BASE_URL=https://api.zai.example",
        "GLM_API_KEY=REPLACE_WITH_YOUR_KEY",
        "GLM_MODEL=glm-4.5",
        "GLM_TEMPERATURE=0.7",
        "GLM_MAX_TOKENS=2000",
        "GLM_ENDPOINT=/glm/v1/chat/completions"
      ].join("\\n");
      const el = document.getElementById('envSample');
      el.style.display = 'block';
      el.textContent = sample;
      navigator.clipboard?.writeText(sample).then(()=> alert('Sample env copied to clipboard'));
    }

    async function sendPrompt(){
      const prompt = document.getElementById('prompt').value.trim();
      if(!prompt) return;
      addMessage(prompt, true);

      // Prepare payload
      const payload = {
        prompt: prompt,
        model: document.getElementById('model').value,
        temperature: parseFloat(document.getElementById('temp').value) || 0.7,
        max_tokens: parseInt(document.getElementById('maxTokens').value) || 90000,
        stream: document.getElementById('stream').checked
      };

      // Call Netlify proxy
      try{
        const res = await fetch('/.netlify/functions/glm-proxy', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(res.ok){
          const reply = data.reply || '';
          if(payload.stream){
            // Simulate streaming by revealing in chunks
            await simulateStreaming(reply);
          } else {
            addMessage(reply, false);
          }
        } else {
          addMessage('Error: ' + (data?.error || 'Unknown error'), false);
        }
      }catch(e){
        addMessage('Network error: ' + (e?.message || e), false);
      }
    }

    async function simulateStreaming(text){
      const total = text;
      const chunkSize = Math.max(6, Math.floor(total.length
