<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>GLM-4.5 Chatbot ‚Äî Tablet Optimized</title>

  <!-- Prism theme -->
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet"/>

  <style>
    :root{
      --bg: #f5f7fb;
      --card: #fafaff;
      --border: #c7c9cf;
      --primary: #2a72ff;
      --muted: #6b7280;
      --message-radius: 12px;
      --touch-size: 48px; /* recommended min touch target */
    }

    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    /* Container centers on wide screens but uses full width on tablets */
    .container {
      box-sizing: border-box;
      max-width:1100px;
      margin:0 auto;
      height:100vh;
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* Chat card takes most of the screen on tablets */
    .chat-card {
      width:100%;
      height:100%;
      max-height:980px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      display:flex;
      flex-direction:column;
      box-shadow:0 6px 18px rgba(20,24,40,0.06);
      overflow:hidden;
    }

    /* header */
    .chat-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 16px;
      border-bottom:1px solid rgba(0,0,0,0.04);
      background:linear-gradient(180deg, rgba(255,255,255,0.6), transparent);
    }
    .title {font-weight:600;font-size:18px}
    .subtitle {font-size:13px;color:var(--muted)}

    /* controls */
    .controls {display:flex;gap:8px;align-items:center}
    .select, .icon-btn {
      height:var(--touch-size);
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:white;
      font-size:15px;
    }
    .icon-btn {display:inline-flex;align-items:center;justify-content:center;min-width:var(--touch-size);cursor:pointer}
    .icon-btn:active{transform:translateY(1px)}

    /* messages: flexible area */
    .messages {
      flex:1 1 auto;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    }

    .msg {
      max-width:85%;
      word-break:break-word;
      white-space:pre-wrap;
      padding:12px;
      border-radius:var(--message-radius);
      line-height:1.45;
      font-size:16px;
    }
    .msg.user {background:#d7e9ff;align-self:flex-end;border-bottom-right-radius:6px}
    .msg.bot {background:#f1f3f5;align-self:flex-start;border-bottom-left-radius:6px;color:#111}

    /* code blocks styling: make block full-width and touch-friendly */
    pre {
      margin:8px 0;
      border-radius:10px;
      overflow:auto;
      font-size:14px;
    }
    pre code {display:block;padding:12px 14px}
    .code-wrapper {position:relative}
    .copy-btn {
      position:absolute;
      top:8px;
      right:8px;
      background:rgba(255,255,255,0.9);
      border:1px solid var(--border);
      padding:6px 8px;
      border-radius:8px;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    /* input area: sticky at bottom for tablet, larger touch targets */
    .input-area {
      border-top:1px solid rgba(0,0,0,0.04);
      padding:10px;
      display:flex;
      gap:8px;
      align-items:flex-end;
      background:linear-gradient(0deg, rgba(255,255,255,0.6), transparent);
      flex-shrink:0;
    }
    textarea.input {
      flex:1;
      min-height:var(--touch-size);
      max-height:180px;
      resize:none;
      padding:12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:16px;
      line-height:1.4;
    }
    button.send {
      min-width:var(--touch-size);
      height:var(--touch-size);
      background:var(--primary);
      color:white;
      border:none;
      border-radius:10px;
      padding:0 16px;
      font-weight:600;
      font-size:15px;
      cursor:pointer;
    }

    /* responsive tweaks for small tablets and phones */
    @media (max-width:720px) {
      .container {padding:10px}
      .chat-card {border-radius:12px}
      .title {font-size:16px}
      .subtitle {font-size:12px}
      .msg {font-size:15px}
      .select, .icon-btn{height:44px}
      .input {font-size:15px}
    }

    /* landscape on tablets: use two-column layout possibility */
    @media (min-width:900px) and (orientation:landscape) {
      .chat-card {max-width:1000px;height:78vh}
    }

    /* accessibility focus */
    .select:focus, .input:focus, .send:focus, .icon-btn:focus {outline:3px solid rgba(42,114,255,0.16);outline-offset:2px}
  </style>
</head>
<body>
  <div class="container">
    <div class="chat-card" role="application" aria-label="GLM-4.5 Chatbot">
      <div class="chat-header">
        <div>
          <div class="title">GLM-4.5 Chat (Tablet)</div>
          <div class="subtitle">‡πÇ‡∏´‡∏°‡∏î: <span id="mode-label">‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥</span> ¬∑ ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: Senior Engineer (Coding & Web Design)</div>
        </div>
        <div class="controls" aria-hidden="false">
          <select id="output-mode" class="select" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå">
            <option value="chat">‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (Chat)</option>
            <option value="code">‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (Code Only)</option>
            <option value="explain+code">‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢+‡πÇ‡∏Ñ‡πâ‡∏î (Explain + Code)</option>
            <option value="json">JSON Only</option>
          </select>
          <button id="clear-btn" class="icon-btn" title="‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤" aria-label="‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤">üßπ</button>
          <button id="copy-last-btn" class="icon-btn" title="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î" aria-label="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î">üìã</button>
        </div>
      </div>

      <div id="glm-messages" class="messages" role="log" aria-live="polite"></div>

      <form id="glm-form" class="input-area" autocomplete="off" aria-label="‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°">
        <textarea id="glm-input" class="input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°... (‡∏Å‡∏î Shift+Enter ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà, Enter ‡∏™‡πà‡∏á)" rows="1" aria-label="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"></textarea>
        <button id="glm-send" class="send" type="submit" aria-label="‡∏™‡πà‡∏á">‡∏™‡πà‡∏á</button>
      </form>
    </div>
  </div>

  <!-- Prism + languages -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>

  <script>
    // ---------------- CONFIG (edit if needed) ----------------
    const API_KEY = "129f947ce9fd44c28a3358a73dbb0173.1TQiPjq06MUytu5P";
    const ENDPOINT = "https://open.bigmodel.cn/api/paas/v4/chat/completions";
    // keep last N messages to limit context
    const CONTEXT_LIMIT = 20;

    // ---------------- STATE ----------------
    let outputMode = localStorage.getItem('glm_output_mode') || "chat";
    let systemPrompt = getSystemPrompt(outputMode);
    let conversation = [{ role: "system", content: systemPrompt }];

    // ---------------- UI refs ----------------
    const messagesDiv = document.getElementById('glm-messages');
    const inputEl = document.getElementById('glm-input');
    const form = document.getElementById('glm-form');
    const outputSelect = document.getElementById('output-mode');
    const modeLabel = document.getElementById('mode-label');
    const clearBtn = document.getElementById('clear-btn');
    const copyLastBtn = document.getElementById('copy-last-btn');

    // Initialize UI values
    outputSelect.value = outputMode;
    modeLabel.textContent = outputSelect.options[outputSelect.selectedIndex].text;

    // ---------------- Helpers ----------------

    function getSystemPrompt(mode) {
      switch (mode) {
        case "chat":
          return `You are a senior engineer who specializes in coding and web design. Always provide clear, efficient, and well-structured code with best practices when relevant. If the user speaks Thai, answer in Thai; otherwise, use English. Respond conversationally.`;
        case "code":
          return `You are a senior engineer. Return only the code in language-specific code blocks (e.g., \`\`\`python ...\`\`\`). Do not add explanation or comments unless requested.`;
        case "explain+code":
          return `You are a senior engineer. Briefly explain your approach in 1-2 sentences, then provide the code in the proper code block (e.g., \`\`\`python ...\`\`\`). Reply in Thai if user speaks Thai.`;
        case "json":
          return `You are a senior engineer. Return only a JSON object in a \`\`\`json ...\`\`\` code block, no extra explanation.`;
        default:
          return `You are a senior engineer who specializes in coding and web design.`;
      }
    }

    function setOutputMode(mode) {
      outputMode = mode;
      localStorage.setItem('glm_output_mode', mode);
      systemPrompt = getSystemPrompt(mode);
      // replace system message
      conversation = conversation.filter(m => m.role !== 'system');
      conversation.unshift({ role: 'system', content: systemPrompt });
      modeLabel.textContent = outputSelect.options[outputSelect.selectedIndex].text;
    }

    // Escape HTML
    function escapeHTML(str){ return str.replace(/[&<>"']/g, ch => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[ch])); }

    // Render assistant content; create code wrappers and copy buttons
    function renderAssistantContent(text){
      // convert code blocks to pre/code with wrapper; keep other text blocks
      let html = escapeHTML(text)
        .replace(/```(\w+)?\n([\s\S]*?)```/g, (m, lang, code) => {
          lang = lang || 'plaintext';
          const safe = escapeHTML(code);
          // use a wrapper so we can attach copy button later
          return `<div class="code-wrapper"><pre><code class="language-${lang}">${safe}</code></pre><button class="copy-btn" data-lang="${lang}">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button></div>`;
        });
      // preserve newlines for plain text (outside code)
      html = html.replace(/\n/g, '<br>');
      return html;
    }

    // Render the whole conversation (only non-system messages)
    // Optimize: only call Prism.highlightElement for newly inserted code blocks
    function renderChat() {
      // Remove all children and rebuild simple markup; this is acceptable on tablet (moderate messages)
      messagesDiv.innerHTML = '';
      const nonSystem = conversation.filter(m => m.role !== 'system');
      nonSystem.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'msg ' + (msg.role === 'user' ? 'user' : 'bot');
        if (msg.role === 'assistant') {
          div.innerHTML = renderAssistantContent(msg.content || '');
        } else {
          div.innerHTML = escapeHTML(msg.content || '');
        }
        messagesDiv.appendChild(div);
      });

      // After DOM updated, attach copy handlers and highlight newly added code blocks
      // Use requestAnimationFrame to avoid blocking main thread during rendering
      requestAnimationFrame(() => {
        // highlight only code blocks present
        messagesDiv.querySelectorAll('pre code').forEach(codeEl => {
          try {
            Prism.highlightElement(codeEl, false);
          } catch (e) { /* ignore unknown languages */ }
        });
        // Remove previous listeners (delegation below handles it)
        // Scroll to bottom in a gentle way suited to mobile keyboards
        scrollToBottomSmooth();
      });
    }

    // Smooth scroll but keep it fast on tablets
    function scrollToBottomSmooth(){
      try {
        messagesDiv.scrollTo({ top: messagesDiv.scrollHeight, behavior: 'smooth' });
      } catch {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    }

    // Attach delegated event listeners for copy buttons inside messagesDiv
    messagesDiv.addEventListener('click', async (e) => {
      const btn = e.target.closest('.copy-btn');
      if (!btn) return;
      const wrapper = btn.closest('.code-wrapper');
      if (!wrapper) return;
      const codeEl = wrapper.querySelector('pre code');
      if (!codeEl) return;
      const text = codeEl.textContent;
      try {
        await navigator.clipboard.writeText(text);
        btn.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì';
        setTimeout(()=> btn.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 1200);
      } catch {
        // fallback: select and copy
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        btn.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì';
        setTimeout(()=> btn.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 1200);
      }
    });

    // ---------------- Streaming API handling ----------------
    async function sendToGLM(userText){
      // push user msg
      conversation.push({ role: 'user', content: userText });
      renderChat();

      // add assistant placeholder
      conversation.push({ role: 'assistant', content: '' });
      renderChat();
      const idx = conversation.length - 1;

      inputEl.disabled = true;
      const body = {
        model: "glm-4.5",
        messages: conversation.slice(-CONTEXT_LIMIT),
        temperature: 0.8,
        stream: true
      };

      try {
        const res = await fetch(ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + API_KEY
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || `HTTP ${res.status}`);
        }
        if (!res.body) throw new Error('No response body (stream not available)');

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let done = false;
        let buffer = '';

        while (!done) {
          const { value, done: d } = await reader.read();
          done = d;
          if (value) {
            buffer += decoder.decode(value, { stream: true });
            // GLM stream lines often prefixed with "data: {...}"
            const lines = buffer.split('\n');
            buffer = lines.pop(); // remainder
            for (let raw of lines) {
              raw = raw.trim();
              if (!raw) continue;
              if (raw === 'data: [DONE]') { done = true; break; }
              if (!raw.startsWith('data:')) continue;
              const payload = raw.replace(/^data:\s*/, '');
              try {
                const json = JSON.parse(payload);
                const delta = json.choices?.[0]?.delta?.content || '';
                if (delta) {
                  conversation[idx].content += delta;
                  // incremental render (cheap): update last assistant node only
                  updateLastAssistant(conversation[idx].content);
                }
              } catch (err) {
                // ignore JSON parse errors on partial chunks
              }
            }
          }
        }
        // final render to ensure code blocks are properly highlighted
        renderChat();
      } catch (err) {
        conversation[idx].content = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err.message || err);
        renderChat();
      } finally {
        inputEl.disabled = false;
        inputEl.focus();
      }
    }

    // update only last assistant message DOM to reduce reflow
    function updateLastAssistant(text){
      const assistantNodes = Array.from(messagesDiv.querySelectorAll('.msg.bot'));
      const last = assistantNodes[assistantNodes.length - 1];
      if (!last) return;
      last.innerHTML = renderAssistantContent(text);
      // highlight any new code blocks inside last only
      last.querySelectorAll('pre code').forEach(codeEl => {
        try { Prism.highlightElement(codeEl, false); } catch {}
      });
      // auto-scroll to keep typing in view
      scrollToBottomSmooth();
    }

    // ---------------- UI interactions ----------------

    // auto-expand textarea height
    function autosizeTextarea(el){
      el.style.height = 'auto';
      const h = Math.min(180, el.scrollHeight);
      el.style.height = h + 'px';
    }
    inputEl.addEventListener('input', () => autosizeTextarea(inputEl));

    // Send on Enter (but allow Shift+Enter for newline)
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const txt = inputEl.value.trim();
      if (!txt) return;
      sendToGLM(txt);
      inputEl.value = '';
      autosizeTextarea(inputEl);
    });
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        form.requestSubmit();
      }
    });

    // output mode change
    outputSelect.addEventListener('change', (e) => {
      setOutputMode(e.target.value);
    });

    // clear conversation
    clearBtn.addEventListener('click', () => {
      conversation = [{ role: 'system', content: systemPrompt }];
      renderChat();
    });

    // copy last message text (user-friendly)
    copyLastBtn.addEventListener('click', async () => {
      const nonSystem = conversation.filter(m => m.role !== 'system');
      if (!nonSystem.length) return;
      const last = nonSystem[nonSystem.length - 1];
      const text = last.content || '';
      try {
        await navigator.clipboard.writeText(text);
        copyLastBtn.textContent = '‚úì';
        setTimeout(()=> copyLastBtn.textContent = 'üìã', 900);
      } catch {
        copyLastBtn.textContent = '‚úì';
        setTimeout(()=> copyLastBtn.textContent = 'üìã', 900);
      }
    });

    // accessibility: focus input on card click
    document.querySelector('.chat-card').addEventListener('click', (e) => {
      if (e.target === inputEl) return;
      inputEl.focus();
    });

    // Keep keyboard-aware spacing: when virtual keyboard shows on mobile/tablet,
    // ensure messages area bottom padding equals input area height.
    function adjustForInput(){
      // measure input area
      const inputArea = document.querySelector('.input-area');
      const height = inputArea.getBoundingClientRect().height;
      messagesDiv.style.paddingBottom = (height + 18) + 'px';
      scrollToBottomSmooth();
    }
    // call on resize and orientation change
    window.addEventListener('resize', adjustForInput);
    window.addEventListener('orientationchange', () => setTimeout(adjustForInput, 300));
    // initial adjust
    setTimeout(adjustForInput, 300);

    // small helper: copy code by long-press (for devices not supporting click)
    // (Already handled by copy buttons; this is just a fallback no-op.)

    // ---------------- Initialization ----------------
    // initial render
    renderChat();
    inputEl.focus();
  </script>
</body>
</html>
