<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Z AI GLM-4.5 Proxy on Netlify</title>
  <style>
    :root {
      --gold:#d4af37;
      --bg:#f7f5f0;
      --text:#111;
      --muted:#555;
      --card:#fff;
      --border:#e5e5e5;
      --shadow:0 6px 18px rgba(0,0,0,.08);
    }
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: linear-gradient(135deg, #fff 0%, #f6f0e0 60%, #fff 100%);
      color: var(--text);
      margin: 0;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    h2 { margin: 6px 0 12px; font-size: 1.05rem; }
    label { font-size: 12px; color: var(--muted); display: block; margin-top: 8px; }
    input, textarea, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font: inherit; }
    textarea { min-height: 90px; resize: vertical; }
    .row { display: flex; gap: 8px; align-items: center; }
    .btn { display: inline-block; padding: 10px 14px; border-radius: 8px; border: 1px solid #ccc; background: rgba(255,255,255,.9); cursor: pointer; font-weight: 700; }
    .btn.primary { background: linear-gradient(135deg, var(--gold), #ffd000); border: none; }
    .section { margin-bottom: 14px; }
    .messages { height: 42vh; overflow: auto; border-radius: 8px; padding: 6px; border: 1px solid var(--border); background: #fff; }
    .message { display: flex; margin: 6px 0; }
    .user { justify-content: flex-end; }
    .bubble { max-width: 70%; padding: 12px 14px; border-radius: 14px; background: #f2f2f2; }
    .user .bubble { background: linear-gradient(135deg, #111, #333); color: #fff; }
    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Overview -->
    <div class="card" aria-label="ข้อมูลรีโป">
      <h2>โครงสร้าง Netlify GLM-4.5 สำหรับ Z AI</h2>
      <ul>
        <li>Index.html อยู่รากรีโป</li>
        <li>มีโฟลเดอร์ netlify/ และ netlify/functions</li>
        <li>มีไฟล์ netlify.toml</li>
        <li>มีไฟล์ package.json</li>
      </ul>
      <p class="note" style="color:var(--muted);">พร้อม deploy ผ่าน Netlify UI โดยไม่ expose API keys ใน frontend</p>
    </div>

    <!-- UI ตั้งค่า GLM-4.5 ผ่าน proxy -->
    <div class="card" aria-label="UI GLM-4.5">
      <h2>UI GLM-4.5 ผ่าน Netlify Proxy</h2>
      <div class="row" style="margin-bottom:6px;">
        <label>Prompt</label>
      </div>
      <textarea id="prompt" placeholder="พิมพ์ข้อความที่ต้องการถาม..." ></textarea>

      <div class="row" style="margin-top:8px;">
        <div style="flex:1;">
          <label>Model</label>
          <select id="model">
            <option value="glm-4.5" selected>glm-4.5</option>
            <option value="glm-4v-plus">glm-4v-plus</option>
          </select>
        </div>
        <div style="flex:1;">
          <label>Temperature</label>
          <input id="temp" type="number" min="0" max="1" step="0.1" value="0.7" />
        </div>
        <div style="flex:1;">
          <label>Max Tokens</label>
          <input id="maxTokens" type="number" value="2000" />
        </div>
      </div>

      <div class="row" style="margin-top:8px; align-items:center;">
        <label style="display:flex; gap:8px; align-items:center;">
          <input id="stream" type="checkbox" checked />
          Streaming (จริง/ SSE)
        </label>
      </div>

      <button class="btn primary" style="margin-top:8px;" onclick="sendPrompt()">ส่ง</button>
    </div>

    <!-- Conversation -->
    <div class="card" aria-label="Conversation">
      <h2>Conversation</h2>
      <div class="messages" id="messages"></div>
    </div>

    <!-- Deployment envs -->
    <div class="card" aria-label="Environment & Deployment">
      <h2>Netlify Deployment Helpers</h2>
      <p>ตั้งค่า environment ใน Netlify UI ก่อน deploy</p>
      <ul>
        <li>GLM_BASE_URL: URL ของ GLM-4.5 API</li>
        <li>GLM_API_KEY: API key เก็บใน Netlify Secrets</li>
        <li>GLM_ENDPOINT: เช่น /glm/v1/chat/completions</li>
        <li>GLM_MODEL: glm-4.5</li>
        <li>GLM_TEMPERATURE: 0.7</li>
        <li>GLM_MAX_TOKENS: 2000</li>
      </ul>
      <p>ไฟล์สำคัญ: netlify.toml และ netlify/functions/glm-proxy.js</p>
      <button class="btn" onclick="showEnvExample()">ดูตัวอย่าง env</button>
      <pre id="envExample" style="display:none; background:#f7f7f7; padding:8px; border-radius:6px;"></pre>
    </div>
  </div>

  <script>
    const msgs = document.getElementById('messages');
    function addMessage(text, fromUser){
      const row = document.createElement('div');
      row.className = 'message ' + (fromUser ? 'user' : 'bot');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      row.appendChild(bubble);
      msgs.appendChild(row);
      msgs.scrollTop = msgs.scrollHeight;
    }

    function showEnvExample(){
      const sample = [
        "GLM_BASE_URL=https://api.zai.example",
        "GLM_API_KEY=REPLACE_WITH_YOUR_KEY",
        "GLM_ENDPOINT=/glm/v1/chat/completions",
        "GLM_MODEL glm-4.5",
        "GLM_TEMPERATURE=0.7",
        "GLM_MAX_TOKENS=2000"
      ].join("\n");
      const el = document.getElementById('envExample');
      el.style.display = 'block';
      el.textContent = sample;
      navigator.clipboard?.writeText(sample).then(()=> alert('Sample env copied to clipboard'));
    }

    async function sendPrompt(){
      const prompt = document.getElementById('prompt').value.trim();
      if(!prompt) return;
      addMessage(prompt, true);

      const payload = {
        prompt: prompt,
        model: document.getElementById('model').value,
        temperature: parseFloat(document.getElementById('temp').value) || 0.7,
        max_tokens: parseInt(document.getElementById('maxTokens').value) || 2000,
        stream: document.getElementById('stream').checked
      };

      try{
        const res = await fetch('/.netlify/functions/glm-proxy', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        // Streaming path: try to handle a streaming response
        const contentType = res.headers.get('Content-Type') || res.headers.get('content-type') || '';
        if (res.ok && (contentType.includes('text/event-stream') || payload.stream === true)) {
          // Real streaming via SSE-like flow
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          while(true){
            const {done, value} = await reader.read();
            if(done) break;
            buffer += decoder.decode(value, {stream: true});
            let idx;
            while((idx = buffer.indexOf('\n')) >= 0){
              const line = buffer.slice(0, idx).trim();
              buffer = buffer.slice(idx + 1);
              if (line.startsWith('data:')) {
                const data = line.slice(5).trim();
                if (data) addMessage(data, false);
              }
            }
          }
        } else if (res.ok) {
          const data = await res.json();
          const reply = data?.reply ?? '';
          if (payload.stream) {
            // fallback to partial streaming if available in one shot
            addMessage(reply, false);
          } else {
            addMessage(reply, false);
          }
        } else {
          const data = await res.json();
          addMessage('Error: ' + (data?.error || 'Unknown error'), false);
        }
      }catch(e){
        addMessage('Network error: ' + (e?.message || e), false);
      }
    }

  </script>
</body>
</html>
