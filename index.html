import pdfplumber
import re
from typing import List, Dict

# ฟังก์ชันแปลงข้อความเป็นชื่อฟิลด์ที่เหมาะสม
def generate_field_name(text: str, index: int) -> str:
    if not text:
        return f"field_{index}"  # ใช้ชื่อทั่วไปถ้าไม่มีบริบท
    # ลบช่องว่างและอักขระพิเศษ แปลงเป็น snake_case
    text = re.sub(r'[^\w\s]', '', text.lower()).strip()
    text = re.sub(r'\s+', '_', text)
    return text or f"field_{index}"

# ฟังก์ชันดึงข้อมูลฟิลด์จาก PDF
def extract_fields_from_pdf(pdf_path: str) -> List[Dict]:
    fields = []
    with pdfplumber.open(pdf_path) as pdf:
        for page in pdf.pages:
            # ดึงข้อมูลฟิลด์ (AcroForm fields)
            if pdf.doc.acroform:
                acro_fields = pdf.doc.acroform.get_fields()
                for field_name, field in acro_fields.items():
                    field_info = {
                        "name": field_name or "",
                        "type": field.get("/FT", "/Tx"),  # /Tx = text, /Sig = signature, /Btn = checkbox
                        "rect": field.get("/Rect")  # [x0, y0, x1, y1]
                    }
                    fields.append(field_info)
            
            # ดึงข้อความใกล้ฟิลด์เพื่อช่วยตั้งชื่อ (ถ้าไม่มีชื่อ)
            words = page.extract_words()
            for i, field in enumerate(fields):
                if not field["name"]:  # ถ้าไม่มีชื่อฟิลด์
                    x0, y0, x1, y1 = field["rect"]
                    # ค้นหาคำที่อยู่ใกล้ฟิลด์ (เช่น ด้านซ้ายหรือด้านบน)
                    nearby_text = ""
                    for word in words:
                        if abs(word["y0"] - y0) < 20 and word["x0"] < x0:  # ข้อความด้านซ้าย
                            nearby_text += word["text"] + " "
                        elif abs(word["x0"] - x0) < 20 and word["y0"] > y0:  # ข้อความด้านบน
                            nearby_text += word["text"] + " "
                    field["name"] = generate_field_name(nearby_text.strip(), i)
                    # คำนวณ width, height
                    field["width"] = x1 - x0
                    field["height"] = y1 - y0
                    field["x"] = x0
                    field["y"] = y0  # PDF ใช้ y จากด้านล่าง ต้องแปลงถ้าใช้ HTML
    return fields

# ฟังก์ชันสร้าง HTML จากข้อมูลฟิลด์
def generate_html_form(fields: List[Dict], output_path: str, form_title: str = "PDF Form"):
    html = f"""<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>{form_title}</title>
  <style>
    body {{ font-family: Arial, sans-serif; }}
    #customform {{ width: 595px; height: 842px; position: relative; border: 1px solid #ccc; }} /* A4 size in pixels at 72dpi */
  </style>
</head>
<body>
  <div id="customform">
    <h2 style="text-align: center;">{form_title}</h2>
"""
    
    for field in fields:
        field_type = field["type"]
        tag = "text-field"
        input_type = "text"
        extra_attrs = ""
        
        if field_type == "/Tx":  # Text field
            tag = "text-field"
            input_type = "text"
        elif field_type == "/Sig":  # Signature field
            tag = "signature-field"
            input_type = "text"
        elif field_type == "/Btn":  # Checkbox
            tag = "checkbox-field"
            input_type = "checkbox"
        elif field_type == "/DA":  # Date (สมมติว่าเป็น date)
            tag = "date-field"
            input_type = "date"
            extra_attrs = 'format="DD/MM/YYYY"'
        
        # แปลง y จาก PDF (จากด้านล่าง) เป็น HTML (จากด้านบน)
        html_y = 842 - field["y"] - field["height"]  # A4 height = 842px
        
        # เพิ่ม label และ field
        html += f"""
    <label for="{field['name']}" style="position: absolute; left: {field['x'] - 100}px; top: {html_y}px;">{field['name'].replace('_', ' ')}:</label>
    <{tag} name="{field['name']}" id="{field['name']}" type="{input_type}" style="position: absolute; left: {field['x']}px; top: {html_y}px; width: {field['width']}px; height: {field['height']}px;" {extra_attrs}></{tag}>
"""
    
    html += """
  </div>
</body>
</html>
"""
    
    with open(output_path, "w", encoding="utf-8") as f:
        f.write(html)
    print(f"HTML form generated at: {output_path}")

# ตัวอย่างการใช้งาน
pdf_path = "bt44.pdf"  # แทนที่ด้วย path ของ PDF (เช่น บต.44)
output_html_path = "bt44_form.html"
form_title = "บต.44 - แจ้งการเปลี่ยนแปลงนายจ้าง"

# ดึงข้อมูลฟิลด์และสร้าง HTML
fields = extract_fields_from_pdf(pdf_path)
generate_html_form(fields, output_html_path, form_title)
